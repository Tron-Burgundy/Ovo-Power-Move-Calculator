javascript:"use strict";{async function t(){const t="https://twitch-tools.glitch.me/ovo.html?months="+n;if(await async function(){let t=new Date,o=new Date;o.setMonth(o.getMonth()-n-1),t.setMonth(t.getMonth()+1);try{let n=await fetch("https://www.gov.uk/bank-holidays.json");if(n.ok){let a=await n.json();for(let n of a[e].events){let e=new Date(n.date);e>o&&e<t&&(s[n.date]=n.title)}return r("got bank holidays"),!0}}catch(t){}let a=new window.URLSearchParams(window.location.search).get("bh");if(null===a)return!1;try{s=JSON.parse(a)}catch(t){return!1}return!0}()){if("account.ovoenergy.com"==window.location.host)return!0;let t="https://account.ovoenergy.com/usage?fuel=electricity&bh="+encodeURIComponent(JSON.stringify(s));return window.location.href=t,!1}return window.location.href=t,!1}let e="england-and-wales";const n=4;let o,a,i="https://smartpaymapi.ovoenergy.com/usage/api/half-hourly/",r=console.log,l=t=>("0"+t).slice(-2),c=t=>document.getElementById(t),s={},h=t=>g('[<a href="https://account.ovoenergy.com/">CLICK HERE to sign into your Ovo account</a>] <b>then click the bookmark again.</b>'),f=0;function d(t){let e=0;for(let n=0;n<t.length;n++)e+=t[n].consumption;return e}async function u(t=0){let e=m(t),n=0,o=0,a=e.firstDayOfMonth,c=e.year,h=l(e.month),f=0,u=[],y=!0;r("Month: ",e.mthName),g(`Month: ${e.mthName} ${e.year}, peak hours: ${e.peakTimeStart} to ${e.peakTimeEnd}`);let w=t=>{let n=0;for(let o=0;o<t.length;o++){let a=new Date(t[o].interval.start),i=a.getHours();0!=a.getTimezoneOffset()&&i++,i>=e.peakTimeStart&&i<e.peakTimeEnd&&(n+=t[o].consumption)}return n};for(let t=1;t<=e.lastDayOfMonth&&y;t++,a=++a%7){if(new Date(e.year,e.month-1,t)>=Date.now()){r("Ending calcs for the month. Date is >= today",Date.now(),new Date(e.year,e.month-1,t));break}let m=`${c}-${h}-`+l(t),g=i+m,k=await fetch(g,{credentials:"include"});if(!0!==k.ok){r("bad response for",g);continue}p();let D=await k.json();if(y=D?.electricity?.next??!1,!D.electricity){r("No electricity data for "+m);continue}let b=D.electricity.data;if(b instanceof Array!=!1&&0!==b.length){if(48!=b.length&&r(m,"1/2 hourly data length not 48: ",b.length),s[m])r(m+" bank holiday "+s[m]),f++,u.push(s[m]);else if(0===a||6===a)e.weekendsCountOffpeak&&(o+=d(b),r("Weekend counts as offpeak: "+d(b)));else{let e=w(b),a=d(b);o+=a,n+=e,a>0&&r(`${l(t)} day ${(100*e/a).toFixed(3)}% [${e.toFixed(3)}/${a.toFixed(3)}]`)}y||r("DATA ENDS for the month "+m)}else r("1/2 hourly data is empty or not an array",b)}let k=`TOTAL = ${o>0?(n/o*100).toFixed(2)+"%":"Not enough data yet..."} [${n.toFixed(3)} / ${o.toFixed(3)}]kWh - bank holidays: ${f} `+u.join(", ");r(k),r(),g(k),g("&nbsp;")}function m(t=0){let e=new Date,n=new Date(e.getFullYear(),e.getMonth()-t,1),o=new Date(e.getFullYear(),e.getMonth()-t+1,0),[a,i]=n>=new Date(2024,9)?[16,19]:n>=new Date(2024,3)?[18,21]:[16,19],r=n>=new Date(2024,6);return{firstDayOfMonth:n.getDay(),lastDayOfMonth:o.getDate(),month:n.getMonth()+1,mthName:n.toLocaleString("default",{month:"long"}),year:n.getFullYear(),peakTimeStart:a,peakTimeEnd:i,weekendsCountOffpeak:r}}function y(){let t=Object.fromEntries(document.cookie.split("; ").map((t=>t.split("=")))).mp_457e7322cdf0dcb51030b6a3bafd8805_mixpanel;if(void 0!==t){let e=JSON.parse(decodeURIComponent(t));if(a=e["Account Id"],a)return!0}return!1}function g(){for(let t of arguments){let e=document.createElement("div");e.innerHTML=t,msgs.append(e)}}function w(){document.body.innerHTML='<div>Working: [<span id="X">+</span>]<p><div id="msgs"></div></div>',o=c("X")}function p(){f=!f,o.innerText=f?"◉":"◎"}(async()=>{if(0!=await t())if(w(),y()){g("Press F12 for more info"),r("Account id is fine"),i=i+a+"?date=";for(let t=0;t<n;t++)await u(t)}else h()})()}
