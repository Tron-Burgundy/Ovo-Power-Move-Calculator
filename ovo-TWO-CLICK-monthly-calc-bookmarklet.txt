javascript:"use strict";{let e="england-and-wales",t={};const n=4;async function a(){const a="https://twitch-tools.glitch.me/ovo.html?months="+n;return t=i()||await o(n,e),!(!t||"account.ovoenergy.com"!=window.location.host)||(window.location.href=a,!1)}async function o(e=4,t="england-and-wales"){let n=new Date,a=new Date;a.setMonth(a.getMonth()-e-1),n.setMonth(n.getMonth()+1);let o={};try{let e=await fetch("https://www.gov.uk/bank-holidays.json");if(e.ok){let i=await e.json();for(let e of i[t].events){let t=new Date(e.date);t>a&&t<n&&(o[e.date]=e.title)}return o}}catch(e){console.log("ERROR fetching: ",e)}return!1}function i(){let e=new window.URLSearchParams(window.location.search).get("bh");if(null===e)return!1;try{return JSON.parse(e)}catch(e){return k("ERROR getting the bank holidays from the URL"),!1}return!0}function r(e){let[t,n]=[16,19],a=!1;switch(!0){case e>=new Date(2025,1):[t,n]=[17,19];break;case e>=new Date(2024,9):[t,n]=[16,19];break;case e>=new Date(2024,3):[t,n]=[18,21]}if(!0==e>=new Date(2024,6))a=!0;return{peakTimeStart:t,peakTimeEnd:n,weekendsCountOffpeak:a}}let l,s,c="https://smartpaymapi.ovoenergy.com/usage/api/half-hourly/",f=console.log,h=e=>("0"+e).slice(-2),d=e=>document.getElementById(e),u=e=>k('[<a href="https://account.ovoenergy.com/">CLICK HERE to sign into your Ovo account</a>] <b>then click the bookmark again.</b><h2>Do not use private browsing</h2>'),m=0;function g(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n].consumption;return t}async function p(e=0){let n=w(e),a=0,o=0,i=n.firstDayOfMonth,r=n.year,l=h(n.month),s=0,d=[],u=!0;f("Month: ",n.mthName),k(`Month: ${n.mthName} ${n.year}, peak hours: ${n.peakTimeStart} to ${n.peakTimeEnd}`);let m=e=>{let t=0;for(let a=0;a<e.length;a++){let o=new Date(e[a].interval.start),i=o.getHours();0!=o.getTimezoneOffset()&&i++,i>=n.peakTimeStart&&i<n.peakTimeEnd&&(t+=e[a].consumption)}return t};for(let e=1;e<=n.lastDayOfMonth&&u;e++,i=++i%7){if(new Date(n.year,n.month-1,e)>=Date.now()){f("Ending calcs for the month.  Date is >= today",Date.now(),new Date(n.year,n.month-1,e));break}let p=`${r}-${l}-`+h(e),w=c+p,y=await fetch(w,{credentials:"include"});if(!0!==y.ok){f("bad response for",w);continue}b();let k=await y.json();if(u=k?.electricity?.next??!1,!k.electricity){f("No electricity data for "+p);continue}let D=k.electricity.data;if(D instanceof Array!=!1&&0!==D.length){if(48!=D.length&&f(p,"1/2 hourly data length not 48: ",D.length),t[p])f(p+" bank holiday "+t[p]),s++,d.push(t[p]);else if(0===i||6===i)n.weekendsCountOffpeak&&(o+=g(D),f("Weekend counts as offpeak: "+g(D)));else{let t=m(D),n=g(D);o+=n,a+=t,n>0&&f(`${h(e)} day ${(100*t/n).toFixed(3)}%  [${t.toFixed(3)}/${n.toFixed(3)}]`)}u||f("DATA ENDS for the month "+p)}else f("1/2 hourly data is empty or not an array",D)}let p=`TOTAL = ${o>0?(a/o*100).toFixed(2)+"%":"Not enough data yet..."}  [${a.toFixed(3)} / ${o.toFixed(3)}]kWh - bank holidays: ${s} `+d.join(", ");f(p),f(),k(p),k("&nbsp;")}function w(e=0){let t=new Date,n=new Date(t.getFullYear(),t.getMonth()-e,1),a=new Date(t.getFullYear(),t.getMonth()-e+1,0),{peakTimeStart:o,peakTimeEnd:i,weekendsCountOffpeak:l}=r(n);return{firstDayOfMonth:n.getDay(),lastDayOfMonth:a.getDate(),month:n.getMonth()+1,mthName:n.toLocaleString("default",{month:"long"}),year:n.getFullYear(),peakTimeStart:o,peakTimeEnd:i,weekendsCountOffpeak:l}}function y(){let e=Object.fromEntries(document.cookie.split("; ").map((e=>e.split("=")))).mp_457e7322cdf0dcb51030b6a3bafd8805_mixpanel;if(void 0!==e){let t=JSON.parse(decodeURIComponent(e));if(s=t["Account Id"],s)return!0}return!1}function k(){for(let e of arguments){let t=document.createElement("div");t.innerHTML=e,msgs.append(t)}}function D(){document.body.innerHTML='<div style="padding: 1em">Working: [<span id="X">+</span>]<p><div id="msgs"></div></div>',l=d("X")}function b(){m=!m,l.innerText=m?"◉":"◎"}(async()=>{if(D(),0!=await a())if(y()){k("Press F12 for more info"),f("Account id is fine"),c=c+s+"?date=";for(let e=0;e<n;e++)await p(e)}else u()})()}
