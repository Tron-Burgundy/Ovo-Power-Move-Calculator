javascript:"use strict";{let e="england-and-wales";async function t(){const t="https://twitch-tools.glitch.me/ovo.html?months="+o;if(await async function(){let t=new Date,n=new Date;n.setMonth(n.getMonth()-o-1),t.setMonth(t.getMonth()+1);try{let o=await fetch("https://www.gov.uk/bank-holidays.json");if(o.ok){let a=await o.json();for(let o of a[e].events){let e=new Date(o.date);e>n&&e<t&&(f[o.date]=o.title)}return l("got bank holidays"),!0}}catch(e){}let a=new window.URLSearchParams(window.location.search).get("bh");if(null===a)return!1;try{f=JSON.parse(a),g("SUCCESS: Got bank holidays from the URL.")}catch(e){return g("ERROR getting the bank holidays from the URL"),!1}return!0}()){if("account.ovoenergy.com"==window.location.host)return!0;let e="https://account.ovoenergy.com/usage?fuel=electricity&bh="+encodeURIComponent(JSON.stringify(f));return window.location.href=e,!1}return window.location.href=t,!1}function n(e){let[t,n]=[16,19],o=!1;switch(!0){case e>=new Date(2025,1):[t,n]=[17,19];break;case e>=new Date(2024,9):[t,n]=[16,19];break;case e>=new Date(2024,3):[t,n]=[18,21]}if(!0==e>=new Date(2024,6))o=!0;return{peakTimeStart:t,peakTimeEnd:n,weekendsCountOffpeak:o}}const o=4;let a,i,r="https://smartpaymapi.ovoenergy.com/usage/api/half-hourly/",l=console.log,c=e=>("0"+e).slice(-2),s=e=>document.getElementById(e),f={},h=e=>g('[<a href="https://account.ovoenergy.com/">CLICK HERE to sign into your Ovo account</a>] <b>then click the bookmark again.</b>'),d=0;function u(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n].consumption;return t}async function m(e=0){let t=y(e),n=0,o=0,a=t.firstDayOfMonth,i=t.year,s=c(t.month),h=0,d=[],m=!0;l("Month: ",t.mthName),g(`Month: ${t.mthName} ${t.year}, peak hours: ${t.peakTimeStart} to ${t.peakTimeEnd}`);let p=e=>{let n=0;for(let o=0;o<e.length;o++){let a=new Date(e[o].interval.start),i=a.getHours();0!=a.getTimezoneOffset()&&i++,i>=t.peakTimeStart&&i<t.peakTimeEnd&&(n+=e[o].consumption)}return n};for(let e=1;e<=t.lastDayOfMonth&&m;e++,a=++a%7){if(new Date(t.year,t.month-1,e)>=Date.now()){l("Ending calcs for the month.  Date is >= today",Date.now(),new Date(t.year,t.month-1,e));break}let y=`${i}-${s}-`+c(e),g=r+y,w=await fetch(g,{credentials:"include"});if(!0!==w.ok){l("bad response for",g);continue}k();let D=await w.json();if(m=D?.electricity?.next??!1,!D.electricity){l("No electricity data for "+y);continue}let b=D.electricity.data;if(b instanceof Array!=!1&&0!==b.length){if(48!=b.length&&l(y,"1/2 hourly data length not 48: ",b.length),f[y])l(y+" bank holiday "+f[y]),h++,d.push(f[y]);else if(0===a||6===a)t.weekendsCountOffpeak&&(o+=u(b),l("Weekend counts as offpeak: "+u(b)));else{let t=p(b),a=u(b);o+=a,n+=t,a>0&&l(`${c(e)} day ${(100*t/a).toFixed(3)}%  [${t.toFixed(3)}/${a.toFixed(3)}]`)}m||l("DATA ENDS for the month "+y)}else l("1/2 hourly data is empty or not an array",b)}let w=`TOTAL = ${o>0?(n/o*100).toFixed(2)+"%":"Not enough data yet..."}  [${n.toFixed(3)} / ${o.toFixed(3)}]kWh - bank holidays: ${h} `+d.join(", ");l(w),l(),g(w),g("&nbsp;")}function y(e=0){let t=new Date,o=new Date(t.getFullYear(),t.getMonth()-e,1),a=new Date(t.getFullYear(),t.getMonth()-e+1,0),{peakTimeStart:i,peakTimeEnd:r,weekendsCountOffpeak:l}=n(o);return{firstDayOfMonth:o.getDay(),lastDayOfMonth:a.getDate(),month:o.getMonth()+1,mthName:o.toLocaleString("default",{month:"long"}),year:o.getFullYear(),peakTimeStart:i,peakTimeEnd:r,weekendsCountOffpeak:l}}function p(){let e=Object.fromEntries(document.cookie.split("; ").map((e=>e.split("=")))).mp_457e7322cdf0dcb51030b6a3bafd8805_mixpanel;if(void 0!==e){let t=JSON.parse(decodeURIComponent(e));if(i=t["Account Id"],i)return!0}return!1}function g(){for(let e of arguments){let t=document.createElement("div");t.innerHTML=e,msgs.append(t)}}function w(){document.body.innerHTML='<div>Working: [<span id="X">+</span>]<p><div id="msgs"></div></div>',a=s("X")}function k(){d=!d,a.innerText=d?"◉":"◎"}(async()=>{if(0!=await t())if(w(),p()){g("Press F12 for more info"),l("Account id is fine"),r=r+i+"?date=";for(let e=0;e<o;e++)await m(e)}else h()})()}
