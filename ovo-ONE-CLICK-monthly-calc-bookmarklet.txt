javascript:"use strict";{const e=4;let t,n,o="https://smartpaymapi.ovoenergy.com/usage/api/half-hourly/",a=console.log,i=e=>("0"+e).slice(-2),r=e=>document.getElementById(e),l={},c=e=>u('[<a href="https://account.ovoenergy.com/">CLICK HERE to sign into your Ovo account</a>] <b>then click the bookmark again.</b>'),s=0;function d(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n].consumption;return t}async function f(e=0){let t=h(e),n=0,r=0,c=t.firstDayOfMonth,s=t.year,f=i(t.month),m=0,y=[],p=!0;a("Month: ",t.mthName),u(`Month: ${t.mthName} ${t.year}, peak hours: ${t.peakTimeStart} to ${t.peakTimeEnd}`);let k=e=>{let n=0;for(let o=0;o<e.length;o++){let a=new Date(e[o].interval.start),i=a.getHours();0!=a.getTimezoneOffset()&&i++,i>=t.peakTimeStart&&i<t.peakTimeEnd&&(n+=e[o].consumption)}return n};for(let e=1;e<=t.lastDayOfMonth&&p;e++,c=++c%7){if(new Date(t.year,t.month-1,e)>=Date.now()){a("Ending calcs for the month.  Date is >= today",Date.now(),new Date(t.year,t.month-1,e));break}let h=`${s}-${f}-`+i(e),u=o+h,D=await fetch(u,{credentials:"include"});if(!0!==D.ok){a("bad response for",u);continue}g();let w=await D.json();if(p=w?.electricity?.next??!1,!w.electricity){a("No electricity data for "+h);continue}let b=w.electricity.data;if(b instanceof Array!=!1&&0!==b.length){if(48!=b.length&&a(h,"1/2 hourly data length not 48: ",b.length),l[h])a(h+" bank holiday "+l[h]),m++,y.push(l[h]);else if(0===c||6===c)t.weekendsCountOffpeak&&(r+=d(b),a("Weekend counts as offpeak: "+d(b)));else{let t=k(b),o=d(b);r+=o,n+=t,o>0&&a(`${i(e)} day ${(100*t/o).toFixed(3)}%  [${t.toFixed(3)}/${o.toFixed(3)}]`)}p||a("DATA ENDS for the month "+h)}else a("1/2 hourly data is empty or not an array",b)}let D=`TOTAL = ${r>0?(n/r*100).toFixed(2)+"%":"Not enough data yet..."}  [${n.toFixed(3)} / ${r.toFixed(3)}]kWh - bank holidays: ${m} `+y.join(", ");a(D),a(),u(D),u("&nbsp;")}function h(e=0){let t=new Date,n=new Date(t.getFullYear(),t.getMonth()-e,1),o=new Date(t.getFullYear(),t.getMonth()-e+1,0),[a,i]=n>=new Date(2024,9)?[16,19]:n>=new Date(2024,3)?[18,21]:[16,19],r=n>=new Date(2024,6);return{firstDayOfMonth:n.getDay(),lastDayOfMonth:o.getDate(),month:n.getMonth()+1,mthName:n.toLocaleString("default",{month:"long"}),year:n.getFullYear(),peakTimeStart:a,peakTimeEnd:i,weekendsCountOffpeak:r}}function m(){let e=Object.fromEntries(document.cookie.split("; ").map((e=>e.split("=")))).mp_457e7322cdf0dcb51030b6a3bafd8805_mixpanel;if(void 0!==e){let t=JSON.parse(decodeURIComponent(e));if(n=t["Account Id"],n)return!0}return!1}function u(){for(let e of arguments){let t=document.createElement("div");t.innerHTML=e,msgs.append(t)}}function y(){document.body.innerHTML='<div>Working: [<span id="X">+</span>]<p><div id="msgs"></div></div>',t=r("X")}function g(){s=!s,t.innerText=s?"◉":"◎"}(async()=>{if(0!=await void("account.ovoenergy.com"===window.location.host?l={"2024-04-01":"Easter Monday","2024-05-06":"Early May bank holiday","2024-05-27":"Spring bank holiday","2024-08-26":"Summer bank holiday","2024-12-25":"Christmas Day","2024-12-26":"Boxing Day"}:window.location.href="https://account.ovoenergy.com/usage?fuel=electricity"))if(y(),m()){u("Press F12 for more info"),a("Account id is fine"),o=o+n+"?date=";for(let t=0;t<e;t++)await f(t)}else c()})()}
