javascript:"use strict";let e="england-and-wales";const t=4;let o="https://smartpaymapi.ovoenergy.com/usage/api/half-hourly/";const n="https://blank.org/",a="https://account.ovoenergy.com/usage?fuel=electricity",i="https://www.gov.uk/bank-holidays.json";let r,l,c=console.log,s=e=>("0"+e).slice(-2),d=e=>document.getElementById(e),h={},u=e=>k('<b>Part 1 of 3:</b> [<a href="https://account.ovoenergy.com/">CLICK HERE to sign into your Ovo account</a>] <b>then click the bookmark again.</b>'),f=0;function m(){k("Click the link below and then use the saved bookmark on the blank page."),k("You'll then be returned to Ovo where you must use the bookmark again."),k('<a href="'+n+'">CLICK HERE, use the bookmark, then use it again on your return.</a>'),k("&nbsp;"),k("Bank holiday data makes the Power Move calculations more accurate.")}async function g(){let t=new Date,o=new Date;o.setMonth(o.getMonth()-4-1),t.setMonth(t.getMonth()+1);try{let n=await fetch(i);if(n.ok){let a=await n.json();for(let n of a[e].events){let e=new Date(n.date);e>o&&e<t&&(h[n.date]=n.title)}return c("got bank holidays"),!0}}catch(e){}let n=new window.URLSearchParams(window.location.search).get("bh");if(null===n)return!1;try{h=JSON.parse(n)}catch(e){return!1}return!0}async function y(e=0){let t=w(e),n=0,a=0,i=t.fdom,r=t.year,l=s(t.month),d=0,u=[],f=!0;c("Month: ",t.mthName),k("Month: "+t.mthName+" "+t.year+", peak hours : "+t.peakTimeStart+" to "+t.peakTimeEnd);for(let e=1;e<=t.ldom&&f;e++,i=++i%7){if(new Date(t.year,t.month-1,e)>=Date.now()){console.log("Ending calcs for the month. Date is >= today",Date.now(),new Date(t.year,t.month-1,e));break}let m=`${r}-${l}-`+s(e),g=o+m,y=await fetch(g,{credentials:"include"});if(!0!==y.ok){c("bad response for",g);continue}v();let w=await y.json();if(f=void 0!==w.electricity&&null!==w.electicity&&void 0!==w.electricity.next&&w.electricity.next,f||console.log("DATA ENDS for the month "+m),i>0&&i<6){if(h[m]){c(m+" bank holiday "+h[m]),d++,u.push(h[m]);continue}if(w.electricity){let o=w.electricity.data;if(o instanceof Array==0){c("1/2 hourly data is not an array",o);continue}48!=o.length&&c(m,"1/2 hourly data length not 48: ",o.length);let i=0,r=0;for(let e=0;e<o.length;e++){r+=o[e].consumption;let n=new Date(o[e].interval.start),a=n.getHours();0!=n.getTimezoneOffset()&&a++,a>=t.peakTimeStart&&a<t.peakTimeEnd&&(i+=o[e].consumption)}if(a+=r,n+=i,c(`${s(e)} day ${(100*i/r).toFixed(3)}% [${i.toFixed(3)}/${r.toFixed(3)}]`),!0!==w.electricity.next)break}else c("Nooo for "+m)}}let m=`TOTAL = ${a>0?(n/a*100).toFixed(2)+"%":"Not enough data yet..."} [${n.toFixed(3)} / ${a.toFixed(3)}]kWh - bank holidays: ${d} `+u.join(", ");c(m),c(),k(m),k("&nbsp;")}function w(e=0){let t=new Date,o=new Date(t.getFullYear(),t.getMonth()-e,1),n=new Date(t.getFullYear(),t.getMonth()-e+1,0),[a,i]=o>=new Date(2024,3)?[18,21]:[16,19];return{fdom:o.getDay(),ldom:n.getDate(),month:o.getMonth()+1,mthName:o.toLocaleString("default",{month:"long"}),year:o.getFullYear(),peakTimeStart:a,peakTimeEnd:i}}function p(){let e=Object.fromEntries(document.cookie.split("; ").map((e=>e.split("=")))).mp_457e7322cdf0dcb51030b6a3bafd8805_mixpanel;if(void 0!==e){let t=JSON.parse(decodeURIComponent(e));if(l=t["Account Id"],l)return!0}return!1}function k(){for(let e of arguments){let t=document.createElement("div");t.innerHTML=e,msgs.append(t)}}function b(){document.body.innerHTML='<div>Working: [<span id="X">+</span>]<p><div id="msgs"></div></div>',r=d("X")}function v(){f=!f,r.innerText=f?"◉":"◎"}(async()=>{if("account.ovoenergy.com"===window.location.host)if(b(),"account.ovoenergy.com"!=window.location.host||p())if(k("Press F12 for more info"),c("Account id is fine"),o=o+l+"?date=",await g())for(let e=0;e<4;e++)await y(e);else m();else u();else{if(!await g())return void(window.location.href=a);let e=a+"&bh="+encodeURIComponent(JSON.stringify(h));window.location.href=e}})();
